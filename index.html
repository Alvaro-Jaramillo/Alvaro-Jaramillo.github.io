<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Industry Signals Dashboard</title>
    <meta name="description" content="USA/Canada facility, investment, automation and leadership signals" />
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <body>
    <div style="background: linear-gradient(90deg,#6ab0ff,#4a90e2); padding:20px; text-align:center; border-bottom:4px solid #22242b;">
      <h1 style="margin:0; font-size:32px; font-weight:800; color:white; text-shadow:1px 1px 4px rgba(0,0,0,0.4);">
        AJ's Automation Links v2!
      </h1>
      <div style="margin-top:6px; color:rgba(255,255,255,0.9); font-weight:600; font-size:14px;">
        USA + Canada signals · refreshed every 30 minutes
      </div>
    </div>

    <div class="container">
      <div class="header">
        <div>
          <div class="title">Industry Signals Dashboard</div>
          <div class="subtitle">Broad monitoring for investments, facilities, automation projects, revenue mentions, and leadership moves</div>
        </div>

        <div class="controls">
          <input id="q" type="search" placeholder="Search titles (ex: 'AS/RS', 'Ontario', 'capex')" />
          <select id="sort">
            <option value="published_desc">Newest first</option>
            <option value="published_asc">Oldest first</option>
            <option value="title_asc">Title A→Z</option>
            <option value="title_desc">Title Z→A</option>
          </select>
          <button id="clear" class="btn">Clear filters</button>
        </div>
      </div>

      <div class="layout">
        <aside class="panel">
          <div class="panel-title">Filters</div>

          <div class="filter-block">
            <div class="filter-label">Topic</div>
            <div class="chips" id="topics"></div>
          </div>

          <div class="filter-block">
            <div class="filter-label">Country</div>
            <div class="row">
              <label class="check"><input type="checkbox" id="c_us" checked /> USA</label>
              <label class="check"><input type="checkbox" id="c_ca" checked /> Canada</label>
            </div>
          </div>

          <div class="filter-block">
            <div class="filter-label">Region (state / province)</div>
            <select id="region">
              <option value="">All regions</option>
            </select>
          </div>

          <div class="filter-block">
            <div class="filter-label">Signals</div>
            <label class="check"><input type="checkbox" id="sig_money" /> Has $ investment</label>
            <label class="check"><input type="checkbox" id="sig_sqft" /> Has sqft</label>
            <label class="check"><input type="checkbox" id="sig_jobs" /> Has jobs</label>
          </div>

          <div class="filter-block">
            <div class="filter-label">Source</div>
            <div class="chips" id="sources"></div>
          </div>

          <div class="filter-block">
            <div class="filter-label">Time</div>
            <select id="range">
              <option value="all">All time</option>
              <option value="24h" selected>Last 24 hours</option>
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
            </select>
          </div>

          <div class="panel-footer" id="stats"></div>
        </aside>

        <main>
          <div class="grid" id="grid"></div>
        </main>
      </div>

      <div class="footer">
        Updated 2026-01-07 14:31 UTC · Generated by GitHub Actions
      </div>
    </div>

    <script>
      const grid = document.getElementById('grid');
      const q = document.getElementById('q');
      const sort = document.getElementById('sort');
      const clearBtn = document.getElementById('clear');

      const topicsWrap = document.getElementById('topics');
      const sourcesWrap = document.getElementById('sources');
      const regionSel = document.getElementById('region');
      const rangeSel = document.getElementById('range');
      const stats = document.getElementById('stats');

      const cUS = document.getElementById('c_us');
      const cCA = document.getElementById('c_ca');
      const sigMoney = document.getElementById('sig_money');
      const sigSqft = document.getElementById('sig_sqft');
      const sigJobs = document.getElementById('sig_jobs');

      let all = [];
      let topicMeta = [];
      let selectedTopics = new Set();
      let selectedSources = new Set();

      function fmtMoney(n) {
        if (!n || isNaN(n)) return '';
        if (n >= 1e9) return '$' + (n/1e9).toFixed(2).replace(/\.0+$/,'') + 'B';
        if (n >= 1e6) return '$' + (n/1e6).toFixed(2).replace(/\.0+$/,'') + 'M';
        if (n >= 1e3) return '$' + (n/1e3).toFixed(2).replace(/\.0+$/,'') + 'K';
        return '$' + Math.round(n);
      }

      function fmtNum(n) {
        if (!n || isNaN(n)) return '';
        return Math.round(n).toLocaleString();
      }

      function topicLabel(key) {
        const t = topicMeta.find(x => x.key === key);
        return t ? t.label : key;
      }

      function buildChips(container, values, selectedSet, prefix) {
        container.innerHTML = '';
        values.forEach(v => {
          const id = prefix + '-' + v.replace(/[^a-z0-9]+/gi, '-').toLowerCase();
          const label = document.createElement('label');
          label.className = 'chip';
          label.innerHTML = `<input type="checkbox" id="${id}" checked /> <span>${v}</span>`;
          container.appendChild(label);
          document.getElementById(id).addEventListener('change', e => {
            if (e.target.checked) selectedSet.add(v); else selectedSet.delete(v);
            render();
          });
          selectedSet.add(v);
        });
      }

      function buildTopicChips() {
        topicsWrap.innerHTML = '';
        topicMeta.forEach(t => {
          const id = 'topic-' + t.key;
          const label = document.createElement('label');
          label.className = 'chip';
          label.innerHTML = `<input type="checkbox" id="${id}" checked /> <span>${t.label}</span>`;
          topicsWrap.appendChild(label);
          document.getElementById(id).addEventListener('change', e => {
            if (e.target.checked) selectedTopics.add(t.key); else selectedTopics.delete(t.key);
            render();
          });
          selectedTopics.add(t.key);
        });
      }

      function buildRegionOptions() {
        const regions = [...new Set(all.map(a => a.region).filter(Boolean))].sort();
        regionSel.innerHTML = '<option value="">All regions</option>' + regions.map(r => `<option value="${r}">${r}</option>`).join('');
      }

      function passesRange(publishedISO) {
        const r = rangeSel.value;
        if (r === 'all') return true;
        const t = new Date(publishedISO || 0).getTime();
        if (!t) return false;
        const now = Date.now();
        const ms = r === '24h' ? 24*60*60*1000 : r === '7d' ? 7*24*60*60*1000 : 30*24*60*60*1000;
        return (now - t) <= ms;
      }

      async function load() {
        const res = await fetch('data/items.json?_=' + Date.now());
        const data = await res.json();
        topicMeta = data.topics || [];
        all = data.items || [];

        buildTopicChips();
        buildRegionOptions();

        const sources = [...new Set(all.map(a => a.source).filter(Boolean))].sort();
        buildChips(sourcesWrap, sources, selectedSources, 'src');

        render();
      }

      function clearFilters() {
        q.value = '';
        sort.value = 'published_desc';
        rangeSel.value = '24h';
        regionSel.value = '';
        cUS.checked = true;
        cCA.checked = true;
        sigMoney.checked = false;
        sigSqft.checked = false;
        sigJobs.checked = false;

        selectedTopics = new Set(topicMeta.map(t => t.key));
        topicMeta.forEach(t => {
          const el = document.getElementById('topic-' + t.key);
          if (el) el.checked = true;
        });

        const sources = [...new Set(all.map(a => a.source).filter(Boolean))];
        selectedSources = new Set(sources);
        sources.forEach(s => {
          const id = 'src-' + s.replace(/[^a-z0-9]+/gi, '-').toLowerCase();
          const el = document.getElementById(id);
          if (el) el.checked = true;
        });
        render();
      }

      function render() {
        const term = (q.value || '').trim().toLowerCase();
        const region = regionSel.value;

        const allowUS = cUS.checked;
        const allowCA = cCA.checked;

        let items = all
          .filter(a => selectedSources.has(a.source))
          .filter(a => (a.topics || []).some(t => selectedTopics.has(t)))
          .filter(a => {
            if (a.country === 'US') return allowUS;
            if (a.country === 'CA') return allowCA;
            // if unknown country, keep only when both checked ("broad" mode)
            return allowUS && allowCA;
          })
          .filter(a => region ? a.region === region : true)
          .filter(a => passesRange(a.published));

        if (sigMoney.checked) items = items.filter(a => a.signals && a.signals.investment_usd);
        if (sigSqft.checked) items = items.filter(a => a.signals && a.signals.sqft);
        if (sigJobs.checked) items = items.filter(a => a.signals && a.signals.jobs);

        if (term) {
          items = items.filter(a => (a.title || '').toLowerCase().includes(term));
        }

        const [key, dir] = sort.value.split('_');
        items.sort((a, b) => {
          if (key === 'published') {
            const da = new Date(a.published || 0).getTime();
            const db = new Date(b.published || 0).getTime();
            return dir === 'asc' ? da - db : db - da;
          }
          if (key === 'title') {
            return dir === 'asc' ? (a.title||'').localeCompare(b.title||'') : (b.title||'').localeCompare(a.title||'');
          }
          return 0;
        });

        stats.textContent = `${items.length} shown · ${all.length} total loaded`;

        grid.innerHTML = items.map(a => {
          const topics = (a.topic_labels || a.topics || []).slice(0, 3);
          const extra = (a.topic_labels || a.topics || []).length - topics.length;
          const signals = [];
          if (a.signals && a.signals.investment_usd) signals.push(fmtMoney(a.signals.investment_usd));
          if (a.signals && a.signals.sqft) signals.push(fmtNum(a.signals.sqft) + ' sqft');
          if (a.signals && a.signals.jobs) signals.push(fmtNum(a.signals.jobs) + ' jobs');

          const subtitle = [
            a.country ? (a.country === 'US' ? 'USA' : 'Canada') : null,
            a.region || null,
            a.source || null,
          ].filter(Boolean).join(' · ');

          return `
            <div class="card">
              <div class="meta">${subtitle}</div>
              <a href="${a.url}" target="_blank" rel="noopener">
                <div class="card-title">${a.title}</div>
              </a>
              <div class="tagrow">
                ${topics.map(t => `<span class="tag">${t}</span>`).join('')}
                ${extra > 0 ? `<span class="tag">+${extra}</span>` : ''}
              </div>
              ${signals.length ? `<div class="signals">${signals.map(s => `<span class="signal">${s}</span>`).join('')}</div>` : ''}
              ${a.published ? `<div class="muted">Seen: ${new Date(a.published).toLocaleString()}</div>` : ''}
              <div class="actions">
                <button class="btn-sm" data-copy="${encodeURIComponent(a.title + ' — ' + a.url)}">Copy</button>
                <button class="btn-sm" data-copy="${encodeURIComponent(buildEmailSnippet(a))}">Copy email snippet</button>
              </div>
            </div>
          `;
        }).join('');

        document.querySelectorAll('[data-copy]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const txt = decodeURIComponent(e.currentTarget.getAttribute('data-copy'));
            try {
              await navigator.clipboard.writeText(txt);
              e.currentTarget.textContent = 'Copied';
              setTimeout(() => e.currentTarget.textContent = 'Copy', 900);
            } catch {
              alert('Copy failed (clipboard permission).');
            }
          });
        });
      }

      function buildEmailSnippet(a) {
        const parts = [];
        const topics = (a.topic_labels || a.topics || []).slice(0, 2).map(t => t);
        if (topics.length) parts.push('Topic: ' + topics.join(', '));
        if (a.region || a.country) parts.push('Region: ' + [a.region, a.country === 'US' ? 'USA' : (a.country === 'CA' ? 'Canada' : a.country)].filter(Boolean).join(', '));
        if (a.signals) {
          const sig = [];
          if (a.signals.investment_usd) sig.push('Investment ' + fmtMoney(a.signals.investment_usd));
          if (a.signals.sqft) sig.push(fmtNum(a.signals.sqft) + ' sqft');
          if (a.signals.jobs) sig.push(fmtNum(a.signals.jobs) + ' jobs');
          if (sig.length) parts.push('Signals: ' + sig.join(' · '));
        }
        const header = parts.length ? ('(' + parts.join(' | ') + ')\n') : '';
        return `${header}${a.title}\n${a.url}`;
      }

      q.addEventListener('input', render);
      sort.addEventListener('change', render);
      regionSel.addEventListener('change', render);
      rangeSel.addEventListener('change', render);
      cUS.addEventListener('change', render);
      cCA.addEventListener('change', render);
      sigMoney.addEventListener('change', render);
      sigSqft.addEventListener('change', render);
      sigJobs.addEventListener('change', render);
      clearBtn.addEventListener('click', clearFilters);

      load();
    </script>
  </body>
</html>
