<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Industry Signals Dashboard</title>
    <meta name="description" content="USA/Canada facility, investment, automation and leadership signals" />
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <body>
    <div style="background: linear-gradient(90deg,#6ab0ff,#4a90e2); padding:20px; text-align:center; border-bottom:4px solid #22242b;">
      <h1 style="margin:0; font-size:32px; font-weight:800; color:white; text-shadow:1px 1px 4px rgba(0,0,0,0.4);">
        AJ's Automation Links!
      </h1>
      <div style="margin-top:6px; color:rgba(255,255,255,0.9); font-weight:600; font-size:14px;">
        USA + Canada signals · refreshed every 30 minutes
      </div>
    </div>

    <div class="container">
      <div class="header">
        <div>
          <div class="title">Industry Signals Dashboard</div>
          <div class="subtitle">Broad monitoring for investments, facilities, automation projects, revenue mentions, and leadership moves</div>
        </div>

        <div class="controls">
          <input id="q" type="search" placeholder="Search titles (ex: 'AS/RS', 'Ontario', 'capex')" />
          <select id="sort">
            <option value="published_desc">Newest first</option>
            <option value="published_asc">Oldest first</option>
            <option value="title_asc">Title A→Z</option>
            <option value="title_desc">Title Z→A</option>
          </select>
          <button id="clear" class="btn">Clear filters</button>
        </div>
      </div>

      <div class="layout">
        <aside class="panel" style="display:none"></aside>

        <main>
          <div class="grid" id="grid"></div>
        </main>
      </div>

      <div class="footer">
        Updated 2026-01-07 14:31 UTC · Generated by GitHub Actions
      </div>
    </div>

    <script>
      const grid = document.getElementById('grid');
      const q = document.getElementById('q');
      const sort = document.getElementById('sort');
      const clearBtn = document.getElementById('clear');

      const topicsWrap = document.getElementById('topics');
      const sourcesWrap = document.getElementById('sources');
      const regionSel = document.getElementById('region');
      const rangeSel = document.getElementById('range');
      const stats = document.getElementById('stats');

      const cUS = document.getElementById('c_us');
      const cCA = document.getElementById('c_ca');
      const sigMoney = document.getElementById('sig_money');
      const sigSqft = document.getElementById('sig_sqft');
      const sigJobs = document.getElementById('sig_jobs');

      let all = [];
      let topicMeta = [];
      let selectedTopics = new Set();
      let selectedSources = new Set();

      function fmtMoney(n) {
        if (!n || isNaN(n)) return '';
        if (n >= 1e9) return '$' + (n/1e9).toFixed(2).replace(/\.0+$/,'') + 'B';
        if (n >= 1e6) return '$' + (n/1e6).toFixed(2).replace(/\.0+$/,'') + 'M';
        if (n >= 1e3) return '$' + (n/1e3).toFixed(2).replace(/\.0+$/,'') + 'K';
        return '$' + Math.round(n);
      }

      function fmtNum(n) {
        if (!n || isNaN(n)) return '';
        return Math.round(n).toLocaleString();
      }

      function topicLabel(key) {
        const t = topicMeta.find(x => x.key === key);
        return t ? t.label : key;
      }

      function buildChips(container, values, selectedSet, prefix) {
        container.innerHTML = '';
        values.forEach(v => {
          const id = prefix + '-' + v.replace(/[^a-z0-9]+/gi, '-').toLowerCase();
          const label = document.createElement('label');
          label.className = 'chip';
          label.innerHTML = `<input type="checkbox" id="${id}" checked /> <span>${v}</span>`;
          container.appendChild(label);
          document.getElementById(id).addEventListener('change', e => {
            if (e.target.checked) selectedSet.add(v); else selectedSet.delete(v);
            render();
          });
          selectedSet.add(v);
        });
      }

      function buildTopicChips() {
        topicsWrap.innerHTML = '';
        topicMeta.forEach(t => {
          const id = 'topic-' + t.key;
          const label = document.createElement('label');
          label.className = 'chip';
          label.innerHTML = `<input type="checkbox" id="${id}" checked /> <span>${t.label}</span>`;
          topicsWrap.appendChild(label);
          document.getElementById(id).addEventListener('change', e => {
            if (e.target.checked) selectedTopics.add(t.key); else selectedTopics.delete(t.key);
            render();
          });
          selectedTopics.add(t.key);
        });
      }

      function buildRegionOptions() {
        const regions = [...new Set(all.map(a => a.region).filter(Boolean))].sort();
        regionSel.innerHTML = '<option value="">All regions</option>' + regions.map(r => `<option value="${r}">${r}</option>`).join('');
      }

      function passesRange(publishedISO) {
        const r = rangeSel.value;
        if (r === 'all') return true;
        const t = new Date(publishedISO || 0).getTime();
        if (!t) return false;
        const now = Date.now();
        const ms = r === '24h' ? 24*60*60*1000 : r === '7d' ? 7*24*60*60*1000 : 30*24*60*60*1000;
        return (now - t) <= ms;
      }

      async function load() {
        const res = await fetch('data/items.json?_=' + Date.now());
        const data = await res.json();
        topicMeta = data.topics || [];
        all = data.items || [];
        render();
      }

      function clearFilters() {
        q.value = '';
        sort.value = 'published_desc';
        render();
      }

      function render() {
        const term = (q.value || '').trim().toLowerCase();

        // No filters for now: show everything that loaded.
        let items = Array.isArray(all) ? [...all] : [];

        // Normalize fields from both schemas (old GDELT + new RSS)
        items = items.map(a => {
          const published = a.published || a.published_at || a.seendate || '';
          const source = a.source || a.source_name || a.domain || '';
          const countryLabel = a.country
            ? (a.country === 'US' ? 'USA' : (a.country === 'CA' ? 'Canada' : a.country))
            : (a.country_code === 'US' ? 'USA' : (a.country_code === 'CA' ? 'Canada' : ''));
          return { ...a, published, source, countryLabel };
        });

        if (term) {
          items = items.filter(a => (a.title || '').toLowerCase().includes(term));
        }

        // Sort
        const [key, dir] = sort.value.split('_');
        items.sort((a, b) => {
          if (key === 'published') {
            const da = new Date(a.published || 0).getTime();
            const db = new Date(b.published || 0).getTime();
            return dir === 'asc' ? da - db : db - da;
          }
          if (key === 'title') {
            return dir === 'asc'
              ? (a.title||'').localeCompare(b.title||'')
              : (b.title||'').localeCompare(a.title||'');
          }
          return 0;
        });

        // Stats (simple)
        stats.textContent = `${items.length} shown · ${all.length} total loaded`;

        grid.innerHTML = items.map(a => {
          const topics = (a.topic_labels || a.topics || []).slice(0, 3);
          const extra = (a.topic_labels || a.topics || []).length - topics.length;

          const signals = [];
          // Support both schemas
          if (a.signals) {
            if (a.signals.investment_usd) signals.push(fmtMoney(a.signals.investment_usd));
            if (a.signals.sqft) signals.push(fmtNum(a.signals.sqft) + ' sqft');
            if (a.signals.jobs) signals.push(fmtNum(a.signals.jobs) + ' jobs');
            if (a.signals.has_investment) signals.push('$ mention');
            if (a.signals.has_sqft) signals.push('sqft mention');
            if (a.signals.has_jobs) signals.push('jobs mention');
          }

          const subtitle = [
            a.countryLabel || null,
            a.region || null,
            a.source || null,
          ].filter(Boolean).join(' · ');

          const seen = a.published ? `<div class="muted">Seen: ${new Date(a.published).toLocaleString()}</div>` : '';

          return `
            <div class="card">
              <div class="meta">${subtitle}</div>
              <a href="${a.url}" target="_blank" rel="noopener">
                <div class="card-title">${a.title}</div>
              </a>
              <div class="tagrow">
                ${topics.map(t => `<span class="tag">${t}</span>`).join('')}
                ${extra > 0 ? `<span class="tag">+${extra}</span>` : ''}
              </div>
              ${signals.length ? `<div class="signals">${signals.map(s => `<span class="signal">${s}</span>`).join('')}</div>` : ''}
              ${seen}
              <div class="actions">
                <button class="btn-sm" data-copy="${encodeURIComponent(a.title + ' — ' + a.url)}">Copy</button>
                <button class="btn-sm" data-copy="${encodeURIComponent(buildEmailSnippet(a))}">Copy email snippet</button>
              </div>
            </div>
          `;
        }).join('');

        document.querySelectorAll('[data-copy]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const txt = decodeURIComponent(e.currentTarget.getAttribute('data-copy'));
            try {
              await navigator.clipboard.writeText(txt);
              e.currentTarget.textContent = 'Copied';
              setTimeout(() => e.currentTarget.textContent = 'Copy', 900);
            } catch {
              alert('Copy failed (clipboard permission).');
            }
          });
        });
      }

      function buildEmailSnippet(a) {
(a) {
        const parts = [];
        const topics = (a.topic_labels || a.topics || []).slice(0, 2).map(t => t);
        if (topics.length) parts.push('Topic: ' + topics.join(', '));
        if (a.region || a.country) parts.push('Region: ' + [a.region, a.country === 'US' ? 'USA' : (a.country === 'CA' ? 'Canada' : a.country)].filter(Boolean).join(', '));
        if (a.signals) {
          const sig = [];
          if (a.signals.investment_usd) sig.push('Investment ' + fmtMoney(a.signals.investment_usd));
          if (a.signals.sqft) sig.push(fmtNum(a.signals.sqft) + ' sqft');
          if (a.signals.jobs) sig.push(fmtNum(a.signals.jobs) + ' jobs');
          if (sig.length) parts.push('Signals: ' + sig.join(' · '));
        }
        const header = parts.length ? ('(' + parts.join(' | ') + ')\n') : '';
        return `${header}${a.title}\n${a.url}`;
      }

      q.addEventListener('input', render);
      sort.addEventListener('change', render);
      clearBtn.addEventListener('click', clearFilters);

      load();
    </script>
  </body>
</html>